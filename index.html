<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>converter</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<script>

$(function(){
  $("#src").focus(function() {
    $("#src").select();
  });
  $("#dst").focus(function() {
    $("#dst").select();
  });

  $("#convertKibelaToHatena").click(function() {
    var str = $("#src").val();

    function replaceInline(match, p1, off, str) {
      p1 = p1.replace(/\^/g, "\\^");
      p1 = p1.replace(/_/g, "\\_");
      return "[tex: \\displaystyle " + p1 + "]";
    }

    function replaceBlock(match, p1, off, str) {
      p1 = p1.replace(/\]/g, "\\]");
      return "<pre class=\"math\">[tex: \\displaystyle\n" + p1 + "\n]</pre>\n";
    }

    str = str.replace(/\$\$(.+?)\$\$/g, replaceInline);
    str = str.replace(/(?<=\n)```math\n(.+?)\n```\n/sg, replaceBlock);
    str = str.replace(/(?<=\n)```([a-z]*)\n(.+?)\n```\n/sg, "<pre class=\"$1\">\n$2\n</pre>\n");

    $("#dst").val(str);
  });

  $("#convertMarkdownToWpblog").click(function() {
    const src = $("#src").val();

      // 場当たり的な変換処理の集合

      function splitBlock(lines) {
          const blocks = [];
          var block = [];
          var codeFlag = false;
          for (const line of lines) {
              if (!codeFlag && line == "") {
                  if (block.length > 0) {
                      blocks.push(block);
                      block = [];
                  }
              } else if (codeFlag && line == "```") {
                  block.push(line);
                  codeFlag = false;
              } else if (block.length == 0 && line.startsWith("```")) {
                  block.push(line);
                  codeFlag = true;
              } else {
                  block.push(line);
              }
          }
          if (block.length > 0) {
              blocks.push(block);
          }
          return blocks;
      }

      function convertBlockToTitle(block) {
          const block2 = [];
          var p = 1;
          if (block[0].startsWith("### ")) {
              block2.push("<h3>" + block[0].substring(4) + "</h3>");
          } else if (block[0].startsWith("## ")) {
              block2.push("<h2>" + block[0].substring(3) + "</h2>");
          } else if (block[0].startsWith("# ")) {
              block2.push("<h1>" + block[0].substring(2) + "</h1>");
          } else {
              p = 0;
          }
          if (block.length > 1) {
              return block2.concat(convertBlockToParagraph(block.slice(p)));
          } else {
              return block2;
          }
      }
      function convertBlockToBlogCard(block) {
          const str = block[0].replace(/^-\s\[([^\]]+?)\]\((.+)\)$/g, "[blogcard url=\"$2\"]");
          return [str];
      }
      function convertBlockToList(block) {
          //const block2 = ["<ul>"]; // 既存CSSと相性悪く、ulを付けられない
          const block2 = [];
          for (var i = 0; i < block.length; i++) {
              const line = block[i];
              var line2 = convertInline(line);
              if (block.length == 1) {
                  line2 = line2.replace(/^-\s*/, "<li style=\"margin:30px 0 30px 0\">") + "</li>";
              } else if (i == 0) {
                  line2 = line2.replace(/^-\s*/, "<li style=\"margin:30px 0 0 0\">") + "</li>";
              } else if (i == block.length - 1) {
                  line2 = line2.replace(/^-\s*/, "<li style=\"margin:0 0 30px 0\">") + "</li>";
              } else {
                  line2 = line2.replace(/^-\s*/, "<li>") + "</li>";
              }
              block2.push(line2);
          }
          //block2.push("</ul>");
          return block2;
      }
      function convertBlockToParagraph(block) {
          const block2 = ["<p style=\"margin:30px 0 30px 0\">"];
          for (const line of block) {
              block2.push(line);
          }
          block2.push("</p>");
          return block2;
      }
      function convertBlockToProgrammingCode(block) {
          if (!block[0].startsWith("```") || block[block.length - 1] != "```") {
              return convertBlockToParagraph(block);
          }
          const block2 = [];
          var lang = block[0].substring(3);
          if (lang == "console") {
              lang = "shell";
          }
          block2.push("<pre class=\"brush: " + lang + "; gutter: true;\">");
          for (var i = 1; i < block.length - 1; i++) {
              block2.push(block[i]);
          }
          block2.push("</pre>");
          return block2;
      }
      function convertInline(line) {
          return line;
      }
      function convertBlocks(blocks) {
          const blocks2 = [];
          for (const block of blocks) {
              var block2;
              if (block[0].startsWith("#")) {
                  block2 = convertBlockToTitle(block);
              } else if (block[0].startsWith("-")) {
                  if (block.length == 1 && block[0].match(/^-\s*\[[^\]]+?\]\(.+\)$/)) {
                      block2 = convertBlockToBlogCard(block);
                  } else {
                      block2 = convertBlockToList(block);
                  }
              } else if (block[0].startsWith("```")) {
                  block2 = convertBlockToProgrammingCode(block);
              } else {
                  block2 = convertBlockToParagraph(block);
              }
              blocks2.push(block2);
          }
          return blocks2;
      }

      function toBlogSource(blocks) {
          var lines = [];
          for (const block of blocks) {
              lines = lines.concat(block);
              lines.push("");
          }
          return lines;
      }
      const lines = src.split("\n");
      const blocks = splitBlock(lines);

      console.log(blocks);
      const blocks2 = convertBlocks(blocks);
      console.log(blocks2);

      const lines2 = toBlogSource(blocks2);

      $("#dst").val(lines2.join("\n"));
  });
});

</script>

<style>

#src {
  width: 100%;
  height: 300px;
}

#dst {
  width: 100%;
  height: 300px;
}

</style>

</head>
<body>

<div>
<textarea id="src">
</textarea>
</div>

<div>
  <input id="convertKibelaToHatena" type="button" value="↓kibela-to-hatena">
  <input id="convertMarkdownToWpblog" type="button" value="↓markdown-to-wpblog">
</div>

<div>
<textarea id="dst">
</textarea>
</div>

</body>
</html>
